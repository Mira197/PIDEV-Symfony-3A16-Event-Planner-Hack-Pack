{% extends 'admin/baseAdmin.html.twig' %}

{% block section %}
<section class="section">
    <div class="container-fluid">
        <div class="card-style mb-30">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="text-bold">Promo Codes List</h4>
                <a href="#" class="btn btn-primary" onclick="openPromoForm()">
                    <i class="lni lni-plus mr-1"></i>
                    Add Promo Code
                </a>
            </div>

            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle text-center">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Code</th>
                            <th>Discount (%)</th>
                            <th>Expiration Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for code in codes %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td><strong>{{ code.codePromo }}</strong></td>
                                <td>{{ code.pourcentage }}</td>
                                <td>{{ code.dateExpiration ? code.dateExpiration|date('Y-m-d') : '-' }}</td>
                                <td>
                                    {% if code.dateExpiration and code.dateExpiration < "now"|date %}
                                        <span class="badge bg-danger">Expired</span>
                                    {% else %}
                                        <span class="badge bg-success">Active</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ path('aya_admin_code_promo_edit', {'id': code.id}) }}" class="btn btn-sm btn-warning me-1">
                                        <i class="lni lni-pencil"></i>
                                    </a>
                                    <form method="post" action="{{ path('aya_admin_code_promo_delete', {'id': code.id}) }}" style="display:inline-block;" onsubmit="return confirm('Are you sure you want to delete this promo code?');">
                                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ code.id) }}">
                                        <button class="btn btn-sm btn-danger">
                                            <i class="lni lni-trash-can"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="6">
                                    <em>No promo codes found.</em>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function openPromoForm() {
    Swal.fire({
        title: 'Add New Promo Code',
        html: `
            <input id="code_promo" class="swal2-input" placeholder="Code" required>
            <input id="pourcentage" type="number" min="1" max="100" class="swal2-input" placeholder="Discount (%)" required>
            <input id="date_expiration" type="date" class="swal2-input" required>
        `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: 'Save',
        preConfirm: () => {
            const code = document.getElementById('code_promo').value.trim();
            const discount = document.getElementById('pourcentage').value;
            const expiration = document.getElementById('date_expiration').value;

            if (!code || !discount || !expiration) {
                Swal.showValidationMessage('All fields are required');
                return false;
            }

            return fetch('{{ path("aya_admin_code_promo_new") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    code_promo: code,
                    pourcentage: discount,
                    date_expiration: expiration
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(response.statusText);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    Swal.fire('Success!', 'Promo code added!', 'success').then(() => location.reload());
                } else {
                    Swal.showValidationMessage(data.message || 'An error occurred');
                }
            })
            .catch(error => {
                Swal.showValidationMessage('Error: ' + error);
            });
        }
    });
}
</script>
{% endblock %}
