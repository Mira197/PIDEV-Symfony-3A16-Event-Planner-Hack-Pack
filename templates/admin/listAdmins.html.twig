{% extends 'admin/base.html.twig' %}

{% block head %}
    <link rel="stylesheet" href="{{ asset('assetsdheker/css/adminUsers.css') }}">
    {{ parent() }}
{% endblock %}

{% block section %}
<div class="admin-mui-wrapper">
    <h2>üë• Users Management</h2>

    <div class="admin-filters">
        <input type="text" id="userSearchInput" class="form-control" placeholder="üîç Search users...">
        <a href="{{ path('app_user_export_pdf') }}" target="_blank" class="main-btn primary-btn btn-hover export-btn">
            <i class="lni lni-printer"></i> Export PDF
        </a>

        <!-- Bouton pour ouvrir le modal -->
        <button class="main-btn info-btn btn-hover export-btn" data-bs-toggle="modal" data-bs-target="#adminRegisterModal">
            <i class="lni lni-plus"></i> Add Admin
        </button>

        <!-- Modal avec formulaire -->
        <div class="modal fade" id="adminRegisterModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content card-style">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="lni lni-user-plus"></i> Ajouter un administrateur</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                    </div>
                    <div class="modal-body">
                        {{ form_start(adminForm, { 'attr': { 'action': path('admin_register'), 'class': 'row g-3' }, 'method': 'POST' }) }}

                        <div class="col-md-6 input-style-1">
                            <label>Nom</label>
                            {{ form_widget(adminForm.lastName) }}
                            {{ form_errors(adminForm.lastName) }}
                        </div>

                        <div class="col-md-6 input-style-1">
                            <label>Pr√©nom</label>
                            {{ form_widget(adminForm.firstName) }}
                            {{ form_errors(adminForm.firstName) }}
                        </div>

                        <div class="col-md-6 input-style-1">
                            <label>Nom d'utilisateur</label>
                            {{ form_widget(adminForm.username) }}
                            {{ form_errors(adminForm.username) }}
                        </div>

                        <div class="col-md-6 input-style-1">
                            <label>Email</label>
                            {{ form_widget(adminForm.email) }}
                            {{ form_errors(adminForm.email) }}
                        </div>

                        <div class="col-md-6 input-style-1">
                            <label>Num√©ro de t√©l√©phone</label>
                            {{ form_widget(adminForm.numtel) }}
                            {{ form_errors(adminForm.numtel) }}
                        </div>

                        <div class="col-md-6 input-style-1">
                            <label>Mot de passe</label>
                            {{ form_widget(adminForm.password) }}
                            {{ form_errors(adminForm.password) }}
                        </div>

                        <div class="col-md-6 input-style-1">
                            <label>Confirmation mot de passe</label>
                            {{ form_widget(adminForm.passwordConfirmation) }}
                            {{ form_errors(adminForm.passwordConfirmation) }}
                        </div>

                        <div class="col-12">
                            <button type="submit" class="main-btn primary-btn btn-hover w-100">
                                <i class="lni lni-user-plus"></i> Cr√©er l'admin
                            </button>
                        </div>

                        {{ form_end(adminForm) }}
                    </div>
                </div>
            </div>
        </div>

        <a href="{{ path('app_user_export_excel') }}" target="_blank" class="main-btn success-btn btn-hover export-btn">
            <i class="lni lni-exit-up"></i> Export Excel
        </a>
    </div>

    <!-- Table -->
    <table class="admin-mui-table">
        <thead>
            <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Role</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="userTable">
            {% for user in users %}
                <tr>
                    <td>{{ user.username }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.role }}</td>
                    <td>
                        <button class="btn btn-danger btn-sm delete-user" data-id="{{ user.idUser }}">üóëÔ∏è</button>
                        <button class="btn btn-warning btn-sm edit-user" data-id="{{ user.idUser }}">üñäÔ∏è</button>
                    </td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="4" class="empty-row">No users found.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<!-- Spinner circulaire avec message -->
<div id="mini-spinner" style="display: none;">
  <div class="spinner-box">
    <div class="circular-spinner"></div>
    <p class="spinner-text">Veuillez patienter un peu lors du traitement des informations...</p>
  </div>
</div>

<style>
#mini-spinner {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(255, 255, 255, 0.85);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
}

.spinner-box {
  background: #ffffff;
  padding: 30px;
  border-radius: 12px;
  text-align: center;
  box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
}

.circular-spinner {
  width: 60px;
  height: 60px;
  border: 6px solid #e0d7e6;
  border-top: 6px solid #513452;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 15px;
}

.spinner-text {
  font-family: 'Segoe UI', sans-serif;
  color: #2a1c2b;
  font-size: 18px;
  font-weight: 500;
  animation: pulse 2s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

@keyframes pulse {
  0% { opacity: 0.5; }
  50% { opacity: 1; }
  100% { opacity: 0.5; }
}
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll("form").forEach(form => {
      form.addEventListener("submit", function () {
        document.getElementById("mini-spinner").style.display = "flex";
      });
    });

    window.addEventListener("beforeunload", function () {
      document.getElementById("mini-spinner").style.display = "flex";
    });
  });
</script>
{% block javascripts %}
    {{ parent() }}
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const searchInput = document.getElementById("userSearchInput");
        const tableRows = document.querySelectorAll("#userTable tr");

        searchInput.addEventListener("keyup", function () {
          const filter = this.value.toLowerCase();

          tableRows.forEach(row => {
            const cellsText = row.textContent.toLowerCase();
            row.style.display = cellsText.includes(filter) ? "" : "none";
          });
        });
      });
    </script>
{% endblock %}

{% endblock %}
