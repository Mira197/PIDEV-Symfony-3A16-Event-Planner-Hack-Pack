{% extends 'base.html.twig' %}

{% block stylesheets %}
	{{ parent() }}
	<style>
		nav.fh5co-nav {
			background-color: #cebec9 !important;
			padding: 1px 0 !important;
			max-height: 130px !important;
		}

		.aya-cart-wrapper {
			padding: 30px;
			margin-top: 120px;
		}

		.cart-table th,
		.cart-table td {
			text-align: center;
			vertical-align: middle;
		}

		.cart-actions button {
			border: none;
			background: none;
			font-size: 18px;
		}

		.cart-summary {
			background-color: #f9f9f9;
			border-radius: 10px;
			padding: 20px;
			font-size: 15px;
			box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
		}

		.cart-summary h5 {
			font-weight: bold;
			margin-bottom: 20px;
		}

		.cart-summary .line {
			display: flex;
			justify-content: space-between;
			margin-bottom: 10px;
		}

		.cart-summary .total {
			font-size: 18px;
			font-weight: bold;
		}

		.btn-checkout {
			width: 100%;
			margin-top: 20px;
		}

		.input-group input {
			border-radius: 0.375rem 0 0 0.375rem;
		}

		.input-group .btn {
			border-radius: 0 0.375rem 0.375rem 0;
		}
	</style>
{% endblock %}

{% block content %}
	<div class="container aya-cart-wrapper">
		{% if not user %}
			<div class="text-center">
				<img src="{{ asset('images/empty-cart.png') }}" alt="Cart Empty" class="mb-3" width="120">
				<h2>Your cart is empty</h2>
				<p>Sign in to view your cart and start shopping.</p>
				<a href="{{ path('contact_us') }}" class="btn btn-primary">Sign In / Register</a>
				<a href="{{ path('afficheclient') }}" class="btn btn-outline-secondary">Shop Now</a>
			</div>

		{% elseif cartProducts is empty %}
			<div class="text-center">
				<img src="{{ asset('images/empty-cart.png') }}" alt="Cart Empty" class="mb-3" width="120">
				<h2>Your cart is empty</h2>
				<p>Add items to your cart to begin your order.</p>
				<a href="{{ path('afficheclient') }}" class="btn btn-outline-secondary">Shop Now</a>
			</div>

		{% else %}
			<div class="row">
				<div class="col-md-8">
					<h2 class="mb-4">üõçÔ∏è Shopping Cart</h2>
					<table class="table table-bordered cart-table">
						<thead>
							<tr>
								<th>Image</th>
								<th>Product</th>
								<th>Unit Price</th>
								<th>Quantity</th>
								<th>Subtotal</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							{% for item in cartProducts %}
								<tr>
									<td>
										<img src="data:image/jpeg;base64,{{ item.getProduct().getImage() }}" alt="{{ item.getProduct().getName() }}">
									</td>
									<td>{{ item.product.name }}</td>
									<td>{{ item.product.price }}
										TND</td>
									<td>
										<div class="d-flex justify-content-center align-items-center">
											<button class="btn btn-light btn-sm update-qty" data-id="{{ item.product.product_id }}" data-action="decrease">‚àí</button>
											<span id="qty-{{ item.product.product_id }}" class="mx-2">{{ item.quantity }}</span>
											<button class="btn btn-light btn-sm update-qty" data-id="{{ item.product.product_id }}" data-action="increase" data-stock="{{ item.product.stock.availableQuantity }}">+</button>

										</div>
										<div class="text-danger small mt-1" id="error-msg-{{ item.product.product_id }}"></div>
									</td>
									<td id="subtotal-{{ item.product.product_id }}">{{ item.totalPrice }}
										TND</td>
									<td>
										<a href="#" class="btn btn-sm text-danger delete-item" data-id="{{ item.product.product_id }}" title="Delete">üóëÔ∏è</a>
									</td>
								</tr>
							{% endfor %}
						</tbody>
					</table>

					<!-- Promo Code + Continue Shopping -->
					<div class="d-flex justify-content-between align-items-center mt-4">
						<div class="input-group w-50">
							<input type="text" class="form-control" placeholder="Promo Code">
							<button class="btn btn-outline-primary">Apply</button>
						</div>
						<a href="{{ path('afficheclient') }}" class="text-decoration-none text-dark fw-medium">
							<span style="font-size: 18px;">‚Üê Continue Shopping</span>
						</a>
					</div>
				</div>

				<div class="col-md-4">
					<div class="cart-summary">
						<h5>Cart Summary</h5>
						<div class="line total">
							<span>Total</span>
							<span id="cart-total">{{ total }}
								TND</span>
						</div>

						<div class="line">
							<span>Tax</span>
							<span>+ 0.00 TND</span>
						</div>
						<div class="line">
							<span>Coupon</span>
							<span>‚àí 0.00 TND</span>
						</div>
						<hr>
						<div class="line total">
							<span>Total</span>
							<span>{{ total }}
								TND</span>
						</div>

						<a href="{{ path('aya_order_new') }}" class="btn btn-success btn-checkout">Proceed to Checkout</a>
					</div>
					<a href="{{ path('client_orders') }}" class="text-decoration-none text-dark fw-medium">
						<span style="font-size: 18px;">üßæConsult Orders ‚Üí</span>
					
					</a>
				</div>
			</div>
		{% endif %}
	</div>
{% endblock %}
{% block javascripts %}
	{{ parent() }}
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script src="{{ asset('assetsAya/plugins/jquery/jquery.min.js') }}"></script>
	<script src="{{ asset('assetsAya/plugins/bootstrap/js/bootstrap.bundle.min.js') }}"></script>
	<script src="{{ asset('assetsAya/js/custom.js') }}"></script>
	<script src="{{ asset('assetsAya/plugins/jquery/jquery.min.js') }}"></script>
	<script>
		$(document).ready(function () {
$('.update-qty').click(function () {
const button = $(this);
const productId = button.data('id');
const action = button.data('action');
const stock = parseInt(button.data('stock'));
const qtySpan = $('#qty-' + productId);
const subtotalSpan = $('#subtotal-' + productId);
const totalSpan = $('#cart-total');
const errorMsg = $('#error-msg-' + productId);

let currentQty = parseInt(qtySpan.text());
let unitPrice = parseFloat(subtotalSpan.text()) / currentQty;

// R√©initialiser l‚Äôerreur avant chaque action
errorMsg.text('');

if (action === 'increase') {
if (currentQty >= stock) {
errorMsg.text('Only ' + stock + ' item(s) in stock.');
return;
}
currentQty++;
} else if (action === 'decrease' && currentQty > 1) {
currentQty--;
} else {
return;
}

// üëâ Mise √† jour imm√©diate de l'affichage
qtySpan.text(currentQty);
subtotalSpan.text((unitPrice * currentQty).toFixed(2) + ' TND');

// Recalcul total approximatif
let newTotal = 0;
$('.cart-table tbody tr').each(function () {
let subtotalText = $(this).find('td:nth-child(5)').text().replace(' TND', '');
newTotal += parseFloat(subtotalText);
});
totalSpan.text(newTotal.toFixed(2) + ' TND');

// ‚úÖ Envoi AJAX pour mise √† jour backend
$.ajax({
url: '/aya/cart/update/' + productId,
method: 'PUT',
data: JSON.stringify(
{quantity: currentQty}
),
contentType: 'application/json',
success: function (response) { // tout va bien, rien √† faire ici pour l'instant
},
error: function (xhr) {
const res = JSON.parse(xhr.responseText);
console.log(res);
if (res.error) {
errorMsg.text(res.error + (res.available ? " (Max: " + res.available + ")" : ""));
}
}
});
});
$('.delete-item').click(function (e) {
e.preventDefault();
const productId = $(this).data('id');

Swal.fire({
title: 'Remove Product?',
text: "Do you really want to delete this product from your cart?",
icon: 'warning',
showCancelButton: true,
confirmButtonColor: '#d33',
cancelButtonColor: '#aaa',
confirmButtonText: 'Yes, remove it!',
reverseButtons: true
}).then((result) => {
if (result.isConfirmed) {
$.ajax({
url: '/aya/cart/remove/' + productId,
type: 'DELETE',
success: function (response) { // Supprimer la ligne
$('a[data-id="' + productId + '"]').closest('tr').fadeOut(300, function () {
$(this).remove();

// Recalcul total
let newTotal = 0;
$('.cart-table tbody tr').each(function () {
let subtotalText = $(this).find('td:nth-child(5)').text().replace(' TND', '');
newTotal += parseFloat(subtotalText);
});
$('#cart-total').text(newTotal.toFixed(2) + ' TND');

// Si plus aucun produit, recharge la page
if ($('.cart-table tbody tr').length === 0) {
location.reload();
}
});

// ‚úÖ Feedback visuel
Swal.fire({
icon: 'success',
title: 'Deleted!',
text: 'Product removed from your cart.',
timer: 1500,
showConfirmButton: false
});
},
error: function () {
Swal.fire({icon: 'error', title: 'Oops...', text: 'Something went wrong!'});
}
});
}
});

});

});
	</script>


{% endblock %}
