{% extends 'base.html.twig' %}
{% block title %}Event Details
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	<link rel="stylesheet" href="{{ asset('css/eventcards.css') }}">
{% endblock %}

{% block content %}
	<header id="fh5co-header" class="fh5co-cover fh5co-cover-sm" role="banner" style="background-image:url('{{ asset('images/eventspage8.jpg') }}');">
		<div class="overlay"></div>
		<div class="fh5co-container">
			<div class="row">
				<div class="col-md-8 col-md-offset-2 text-center">
					<div class="display-t">
						<div class="display-tc animate-box" data-animate-effect="fadeIn">
							<h1>Events Page</h1>
							<h2>You can now create your events here freely.</h2>
						</div>
					</div>
				</div>
			</div>
		</div>
	</header>

	<div class="container mt-5">
		<h2 class="mb-4">Event Details</h2>

		<div class="event-details-container">
			<div class="row">
				<div class="col-md-5 text-center">
					{% if event.base64Image %}
						<img src="data:image/jpeg;base64,{{ event.base64Image }}" alt="{{ event.name }}" class="event-details-image">
					{% elseif event.imageFilename %}
						<img src="{{ asset('uploads/' ~ event.imageFilename) }}" alt="{{ event.name }}" class="event-details-image">
					{% else %}
						<p>No image available</p>
					{% endif %}
				</div>

				<div class="col-md-7">
					<table class="event-details-table table ">
					
						<tbody>
							<tr>
								<th>Name</th>
								<td>{{ event.name }}</td>
							</tr>
							<tr>
								<th>Description</th>
								<td>{{ event.description }}</td>
							</tr>
							<tr>
								<th>City</th>
								<td>{{ event.city }}</td>
							</tr>
							<tr>
								<th>Capacity</th>
								<td>{{ event.capacity }}</td>
							</tr>
							<tr>
								<th>Start Date</th>
								<td>{{ event.startDate|date('Y-m-d H:i') }}</td>
							</tr>
							<tr>
								<th>End Date</th>
								<td>{{ event.endDate|date('Y-m-d H:i') }}</td>
							</tr>
						</tbody>
					</table>

					<div class="event-details-buttons">
						<a href="{{ path('app_events') }}" class="main-btn dark-btn-outline btn-hover px-4 py-2 me-2">‚¨Ö Back to List</a>
						<a href="{{ path('booking_list') }}" class="main-btn dark-btn-outline btn-hover px-4 py-2 me-2">Booking List</a>

					</div>
					<div style="margin-top: 30px;"></div>
					<div class="d-flex flex-wrap gap-3">
						<a href="{{ path('event_framevr', { id: event.idEvent }) }}" class="btn btn-outline-primary">
    					üé® Visualize in 3D (FrameVR)
						</a>
						<a href="{{ path('event_add_framevr', { id: event.idEvent }) }}" class="btn btn-outline-secondary">
    					üéÆ Add / Update my FrameVR Room
						</a>
						{% if event.frameVrLink %}
						<div class="text-center mt-4">
    						<a href="{{ event.frameVrLink }}" target="_blank" class="btn btn-success btn-sm px-5">
        					üåü View my FrameVR Room
    						</a>
						</div>
						{% endif %}

						{# Uncomment if needed:
																														                    <a href="{{ path('event_edit', {'id': event.idEvent}) }}" class="main-btn warning-btn-outline btn-hover px-4 py-2 me-2">Edit</a>
																														                    {{ include('event/_delete_form.html.twig') }}
																														                    #}
					</div>
				</div>
			</div>
		</div>

	</div>

	{#available locations affichage#}
	<div class="container mt-5">
		<h2 class="mb-4">Available Venues</h2>
	</div>
	<div class="container mt-4 mb-5">
		<div class="row">
			{% for location in locations %}
				<div class="col-xl-4 col-lg-4 col-md-6 col-sm-6">
					<div class="event-card">
						<div class="event-card-image">
							{% if location.base64Image is defined %}
								<img src="data:image/jpeg;base64,{{ location.base64Image }}" alt="Location image">
							{% elseif location.imageFilename %}
								<img src="{{ asset('uploads/' ~ location.imageFilename) }}" alt="Location image">
							{% else %}
								<img src="{{ asset('images/default.jpg') }}" alt="Default image">
							{% endif %}
						</div>
						<div class="event-card-content">
							<h4>{{ location.name }}</h4>
							<ul>
								<li>
									<i class="fa-solid fa-location-dot" style="color: #99707E;"></i>
									<strong>City:</strong>
									{{ location.city.value }}</li>
								<li>
									<i class="fas fa-users me-1" style="color: #99707E;"></i>
									<strong>Capacity:</strong>
									{{ location.capacity }}</li>
								<li>
									<i class="fa-solid fa-ruler" style="color: #99707E;"></i>
									<strong>Dimension:</strong>
									{{ location.dimension }}</li>
								<li>
									<i class="fas fa-money-bill-wave me-1" style="color: #99707E;"></i>
									<strong>Price:</strong>
									{{ location.price }}
									DT</li>
							</ul>
							<div class="event-card-actions d-flex justify-content-between align-items-center mt-2">

								{#<a href="{{ path('booking_new', {'id': event.idEvent}) }}" class="btn btn-primary action-btn details">Book this venue</a>#}
								<!-- Book button -->
									<a href="{{ path('booking_new', { id: event.idEvent }) ~ '?location_id=' ~ location.idLocation }}" class="btn btn-primary action-btn details"> Book this venue
								</a>

								<!-- Weather button and result -->
								<div>
									<button type="button" class="btn btn-sm btn-outline-info btn-weather" data-bs-toggle="modal" data-bs-target="#weatherModal" data-city="{{ location.city.value }}" data-start="{{ event.startDate|date('Y-m-d') }}" data-end="{{ event.endDate|date('Y-m-d') }}">
										üå§
									</button>
									{#<div class="weather-result mt-1" style="font-size: 14px;"></div>#}
								</div>
							</div>
						</div>
					</div>
				</div>
			{% else %}
				<div class="col-12 text-center">
					<p>No compatible venues found for this event.</p>
				</div>
			{% endfor %}
		</div>

		<!-- üîç BOUTON Suggestions -->
		<div class="text-center mt-4">
			<a href="{{ path('suggested_locations', { eventId: event.idEvent }) }}" class="btn btn-outline-secondary">
				üîç Explore Suggested Locations
			</a>
		</div>

		<!-- Weather Modal -->
		<!-- Custom Weather Modal -->
		<div id="weatherModal" class="custom-modal">
			<div class="custom-modal-content">
				<span class="custom-close">&times;</span>
				<h4 class="mb-3">üå§ Weather Forecast</h4>
				<div id="weatherModalBody">Loading...</div>
			</div>
		</div>


	{% endblock %}

	{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const modal = document.getElementById('weatherModal');
            const modalBody = document.getElementById('weatherModalBody');
            const closeBtn = modal.querySelector('.custom-close');

            // Ouverture modale + fetch m√©t√©o
            document.querySelectorAll('.btn-weather').forEach(button => {
                button.addEventListener('click', function () {
                    const city = this.dataset.city;
                    const start = this.dataset.start;
                    const end = this.dataset.end;

                    modalBody.innerHTML = "Loading...";
                    modal.style.display = 'block';

                    fetch(`/weather?city=${city}&start=${start}&end=${end}`)
                        .then(res => res.json())
                        .then(data => {
                            if (data.error) {
                                modalBody.innerHTML = `<p class="text-danger">Error: ${data.error}</p>`;
                                return;
                            }

                            let html = '<div class="d-flex justify-content-center gap-3 flex-wrap">';
                            data.forEach(day => {
                                html += `
                                    <div class="text-center">
                                        <small>${day.date}</small><br>
                                        <img src="${day.icon}" alt="icon"><br>
                                        ${day.condition}<br>
                                        ${day.temp}¬∞C
                                    </div>`;
                            });
                            html += '</div>';

                            modalBody.innerHTML = html;
                        })
                        .catch(() => {
                            modalBody.innerHTML = `<p class="text-danger">Error loading weather.</p>`;
                        });
                });
            });

            // Fermeture modale avec croix
            closeBtn.onclick = () => {
                modal.style.display = 'none';
            };

            // Fermeture modale si on clique √† l‚Äôext√©rieur du contenu
            window.onclick = (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            };
        });
    </script>
{% endblock %}

