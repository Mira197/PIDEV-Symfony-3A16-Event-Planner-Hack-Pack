{% extends 'base.html.twig' %}

{% block stylesheets %}
	<link rel="stylesheet" href="{{ asset('assetsAya/css/ordercss.css') }}">
	{{ parent() }}
	<style>
		nav.fh5co-nav {
			background-color: #cebec9;
			padding: 1px 0 !important;
			max-height: 130px !important;
		}
		body {
			background-color: #f7f7f7;
		}

		.mui-table-wrapper {
			margin: 100px auto;
			max-width: 1100px;
			background: #fff;
			padding: 20px;
			box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
		}
		.mui-table-wrapper {
			margin: 140px auto 60px; /* ou m√™me 160px si tu veux plus */
			background: #fff;
			padding: 20px;
			border-radius: 15px;
			box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
		}


		.mui-table-wrapper h2 {
			font-size: 26px;
			font-weight: bold;
			text-align: center;
			color: #6b336e;
			margin-bottom: 30px;
		}

		.mui-filters {
			text-align: center;
			margin-bottom: 15px;
		}

		.mui-filters button {
			border: none;
			background: #f1f1f1;
			color: #6b336e;
			font-weight: bold;
			padding: 8px 16px;
			margin: 0 6px;
			border-radius: 20px;
			transition: 0.3s ease;
			cursor: pointer;
		}

		.mui-filters button.active,
		.mui-filters button:hover {
			background-color: #6b336e;
			color: white;
		}

		table.mui-table {
			width: 100%;
			border-collapse: collapse;
			margin-top: 10px;
		}

		table.mui-table th,
		table.mui-table td {
			padding: 12px 14px;
			text-align: center;
			border-bottom: 1px solid #e0e0e0;
		}

		table.mui-table th {
			background-color: #6b336e;
			color: white;
			font-size: 14px;
		}

		table.mui-table td {
			font-size: 14px;
		}

		.mui-status {
			font-weight: bold;
			padding: 4px 10px;
			border-radius: 6px;
		}

		.status-pending {
			background-color: #fff3cd;
			color: #856404;
		}

		.status-filled {
			background-color: #d4edda;
			color: #155724;
		}

		.status-rejected {
			background-color: #f8d7da;
			color: #721c24;
		}
		.status-cancelled {
			background-color: #f8d7da;
			color: #721c24;
		}
		.empty-row {
			text-align: center;
			color: #aaa;
			font-style: italic;
			padding: 20px;
		}
		.mui-filters .form-control {
			padding: 6px 10px;
			border-radius: 20px;
			border: 1px solid #ccc;
			box-shadow: none;
		}

		.mui-filters {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 20px;
}

	</style>
{% endblock %}

{% block content %}
	<div class="mui-table-wrapper">
		<h2>üìã My Orders</h2>

		<div class="mui-filters d-flex align-items-center justify-content-between flex-wrap" style="gap: 10px;">

    <!-- Left: Search -->
    <div class="d-flex align-items-center" style="flex: 1; max-width: 250px;">
        <input type="text" id="orderSearch" placeholder="üîç Search orders..." class="form-control w-100">
    </div>

    <!-- Center: Status Filters -->
    <div class="d-flex flex-wrap justify-content-center" style="gap: 8px;">
        <a href="{{ path('client_orders') }}">
            <button class="{{ currentFilter is empty ? 'active' : '' }}">All</button>
        </a>
        <a href="{{ path('client_orders', {'status': 'PENDING'}) }}">
            <button class="{{ currentFilter == 'PENDING' ? 'active' : '' }}">Pending</button>
        </a>
        <a href="{{ path('client_orders', {'status': 'CONFIRMED'}) }}">
            <button class="{{ currentFilter == 'CONFIRMED' ? 'active' : '' }}">Confirmed</button>
        </a>
        <a href="{{ path('client_orders', {'status': 'CANCELLED'}) }}">
            <button class="{{ currentFilter == 'CANCELLED' ? 'active' : '' }}">Cancelled</button>
        </a>
        <a href="{{ path('client_orders', {'status': 'DELIVERED'}) }}">
            <button class="{{ currentFilter == 'DELIVERED' ? 'active' : '' }}">Delivered</button>
        </a>
    </div>

    <!-- Right: Export -->
    <div>
        <button id="exportCsvBtn" class="btn btn-outline-secondary">‚¨áÔ∏è Export as CSV</button>
    </div>

</div>



		<table class="mui-table">
			<thead>
				<tr>
					<th>#Order</th>
					<th>
						Event Date<br>
						<input type="text" class="filter-input" data-column="1">
					</th>
					<th>
						Address<br>
						<input type="text" class="filter-input" data-column="2">
					</th>
					<th>Status</th>
					<th>Ordered At</th>
					<th>Total (TND)</th>
					<th>Actions</th>
				</tr>
			</thead>

			<tbody>
				{% for order in orders %}
					<tr>
						<td>#{{ loop.index }}</td>
						<td>{{ order.eventDate ? order.eventDate|date('Y-m-d H:i') : 'N/A' }}</td>
						<td>{{ order.exactAddress }}</td>
						<td>
							{% if order.status %}
								<span class="mui-status status-{{ order.status|lower }}">{{ order.status }}</span>
							{% else %}
								<span class="text-muted">No Status</span>
							{% endif %}

						</td>
						<td>{{ order.orderedAt ? order.orderedAt|date('Y-m-d H:i') : 'N/A' }}</td>
						<td>{{ order.totalPrice }}</td>
						<td>
							{% if order.status == 'PENDING' %}
								<form action="{{ path('cancel_order', { id: order.orderId }) }}" method="post" class="cancel-order-form d-inline">
									<button class="btn btn-sm btn-danger">Cancel</button>
								</form>

							{% else %}
								‚Äî
							{% endif %}
						</td>
					</tr>
				{% else %}
					<tr>
						<td colspan="7" class="empty-row">No orders found for this filter.</td>
					</tr>
				{% endfor %}
			</tbody>

		</table>
	</div>
{% endblock %}
{% block javascripts %}
	{{ parent() }}
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script>
		document.addEventListener('DOMContentLoaded', () => {
const cancelForms = document.querySelectorAll('.cancel-order-form');

cancelForms.forEach(form => {
form.addEventListener('submit', function (e) {
e.preventDefault(); // ‚õî emp√™che l'envoi imm√©diat

const actionUrl = form.getAttribute('action');
console.log('üü° Cancel form submitted for:', actionUrl); // ‚úÖ log

Swal.fire({
title: 'Are you sure?',
text: "You are about to cancel this order.",
icon: 'warning',
showCancelButton: true,
confirmButtonColor: '#d33',
cancelButtonColor: '#aaa',
confirmButtonText: 'Yes, cancel it!'
}).then((result) => {
if (result.isConfirmed) {
console.log('‚úÖ Confirmed cancellation, submitting form...');
form.submit(); // ‚úÖ Envoi r√©el ici
} else {
console.log('‚ùå Cancellation aborted by user.');
}
});
});
});
});
document.getElementById("orderSearch").addEventListener("keyup", function () {
const filter = this.value.toLowerCase();
const rows = document.querySelectorAll("table.mui-table tbody tr");

rows.forEach(row => {
const text = row.textContent.toLowerCase();
row.style.display = text.includes(filter) ? "" : "none";
});
});
document.getElementById("exportCsvBtn").addEventListener("click", function () {
const rows = document.querySelectorAll("table.mui-table tr");
let csv = [];

rows.forEach(row => {
let cols = row.querySelectorAll("td, th");
let rowCsv = Array.from(cols).map(col => `"${
col.innerText
}"`).join(",");
csv.push(rowCsv);
});

const csvString = csv.join("\n");
const blob = new Blob([csvString], {type: "text/csv"});
const url = URL.createObjectURL(blob);

const a = document.createElement("a");
a.href = url;
a.download = "my_orders.csv";
a.click();
URL.revokeObjectURL(url);
});
document.querySelectorAll('.filter-input').forEach(input => {
input.addEventListener('input', function () {
const column = this.dataset.column;
const value = this.value.toLowerCase();

document.querySelectorAll("table.mui-table tbody tr").forEach(row => {
const cell = row.querySelectorAll("td")[column];
const match = cell && cell.textContent.toLowerCase().includes(value);
row.style.display = match ? "" : "none";
});
});
});
	</script>
{% endblock %}
