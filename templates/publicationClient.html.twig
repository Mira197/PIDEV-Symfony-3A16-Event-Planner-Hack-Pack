{% extends 'base.html.twig' %}

{% block title %}Forum{% endblock %}

{% block content %}
    <header id="fh5co-header" class="fh5co-cover fh5co-cover-sm" role="banner" style="background-image: linear-gradient(rgba(83, 60, 86, 0.7), rgba(83, 60, 86, 0.7)), url('{{ asset('images/forum.jpg') }}');">
        <div class="fh5co-container">
            <div class="row">
                <div class="col-md-8 col-md-offset-2 text-center">
                    <div class="display-t">
                        <div class="display-tc animate-box" data-animate-effect="fadeIn">
                            <h1 style="color: white; text-shadow: 1px 1px 3px rgba(0,0,0,0.3);">Client Forum</h1>
                            <h2 style="color: #cebec9; font-weight: 300;">Share your experiences with our services</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <section class="fh5co-section-gray" style="background-color: #f8f5f9; padding: 4rem 0;">
        <div class="container">
            <div class="row text-center animate-box">
                <div class="col-md-12">
                    <h3 class="section-title" style="color: #533C56; position: relative; padding-bottom: 15px; margin-bottom: 25px;">
                        Your Posts
                        <span style="position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 80px; height: 3px; background: #99707E;"></span>
                    </h3>
                    <p style="color: #533C56; max-width: 700px; margin: 0 auto 30px; line-height: 1.6;">
                        Welcome to our community space! Here you can read other clients' testimonials or share your own experience.
                    </p>
                    <a href="{{ path('app_publication_new') }}" class="btn btn-primary my-custom-btn" style="background-color: #533C56; border: none; padding: 12px 30px; border-radius: 30px; font-size: 1rem; transition: all 0.3s ease;">
                        Create a Post
                    </a>
                </div>
            </div>

            <!-- Debugging the logged-in user -->
            <div class="debug-user">
                {% if app.session.get('user_id') %}
                    <p>Logged-in user: {{ app.session.get('username') }} (ID: {{ app.session.get('user_id') }})</p>
                {% else %}
                    <p>Please log in to access all forum features.</p>
                    <a href="{{ path('login') }}" class="btn btn-secondary" style="background-color: #99707E; border: none; padding: 8px 20px; border-radius: 20px; color: white; text-decoration: none;">Log In</a>
                {% endif %}
            </div>

            <!-- Afficher les messages flash -->
            {% for label, messages in app.flashes %}
                {% for message in messages %}
                    <div class="alert alert-{{ label }} text-center" style="margin: 20px 0; padding: 10px; border-radius: 5px; color: #533C56;" data-timeout="5000">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endfor %}

            <div class="row" style="margin-top: 40px;">
                <div class="col-md-8 col-md-offset-2">
                    {% for publication in publications %}
                        <div class="panel panel-default animate-box" style="border: none; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 30px; transition: transform 0.3s ease, box-shadow 0.3s ease;">
                            <div class="panel-heading d-flex justify-content-between align-items-center" style="background-color: #533C56; color: white; padding: 15px 20px; border-top-left-radius: 10px; border-top-right-radius: 10px;">
                                <div style="display: flex; align-items: center;">
                                    {% if publication.user and publication.user.imgPath %}
                                        <img src="{{ asset(publication.user.imgPath) }}" alt="User image" style="width: 40px; height: 40px; object-fit: cover; border-radius: 50%; margin-right: 12px; border: 2px solid #bca2bf;">
                                    {% else %}
                                        <div style="width: 40px; height: 40px; background-color: #bca2bf; border-radius: 50%; margin-right: 12px; display: flex; align-items: center; justify-content: center; color: #533C56; font-weight: bold;">
                                            {{ publication.user ? publication.user.username|first|upper : 'A' }}
                                        </div>
                                    {% endif %}
                                    <strong style="font-weight: 600;">{{ publication.user ? publication.user.username : 'Anonymous' }}</strong>
                                </div>

                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="color: #cebec9; font-size: 0.9em;">
                                        posted on
                                        <em>{{ publication.publication_date|date('F j, Y') }}</em>
                                    </span>

                                    <!-- Display the three vertical dots only if the user is logged in -->
                                    {% if app.session.get('user_id') %}
                                        <div class="dropdown text-right" style="position: relative;">
                                            <button class="btn btn-link dropdown-toggle" type="button" data-toggle="dropdown" aria-label="Publication options" style="font-size: 20px; color: white; padding: 0; margin: 0; background: none; border: none;">
                                                ‚ãÆ
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-right" style="min-width: 120px; border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-radius: 5px; padding: 5px 0;">
                                                <!-- Display "Edit" and "Delete" buttons only for the author -->
                                                {% if publication.user and publication.user.id_user == app.session.get('user_id') %}
                                                    <li style="padding: 0;">
                                                        <a href="{{ path('app_publication_edit', {'id': publication.publication_id}) }}" style="display: block; padding: 8px 15px; color: #533C56; text-decoration: none;">
                                                            ‚úèÔ∏è Edit
                                                        </a>
                                                    </li>
                                                    <li style="padding: 0;">
                                                        <form action="{{ path('app_publication_delete', {'id': publication.publication_id}) }}" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this post?')">
                                                            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ publication.publication_id) }}">
                                                            <button type="submit" style="background: none; border: none; padding: 8px 15px; color: #e74c3c; text-decoration: none; cursor: pointer; width: 100%; text-align: left;">
                                                                üóëÔ∏è Delete
                                                            </button>
                                                        </form>
                                                    </li>
                                                {% endif %}
                                                <!-- Display "Report" button only if the user is not the author -->
                                                {% if publication.user and publication.user.id_user != app.session.get('user_id') %}
                                                    <li style="padding: 0;">
                                                        <a href="{{ path('app_report_publication', {'id': publication.publication_id}) }}" style="display: block; padding: 8px 15px; color: #e67e22; text-decoration: none;">
                                                            ‚ö†Ô∏è Report
                                                        </a>
                                                    </li>
                                                {% endif %}
                                            </ul>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="panel-body" style="padding: 25px; background: white; border-bottom-left-radius: 10px; border-bottom-right-radius: 10px;">
                                <!-- Translation dropdown -->
                                <div class="translation-section text-right mb-3">
                                    <form method="GET" action="{{ path('app_publication_client') }}">
                                        <!-- Preserve existing query parameters -->
                                        {% for key, value in app.request.query.all %}
                                            {% if key != 'publication_' ~ publication.publication_id %}
                                                <input type="hidden" name="{{ key }}" value="{{ value }}">
                                            {% endif %}
                                        {% endfor %}
                                        <!-- Translation language select -->
                                        <select name="publication_{{ publication.publication_id }}" onchange="this.form.submit()" style="padding: 5px; border-radius: 5px; border: 1px solid #99707E; color: #533C56;">
                                            <option value="">Translate to...</option>
                                            <option value="en" {% if app.request.query.get('publication_' ~ publication.publication_id) == 'en' %}selected{% endif %}>English</option>
                                            <option value="fr" {% if app.request.query.get('publication_' ~ publication.publication_id) == 'fr' %}selected{% endif %}>French</option>
                                            <option value="es" {% if app.request.query.get('publication_' ~ publication.publication_id) == 'es' %}selected{% endif %}>Spanish</option>
                                            <option value="de" {% if app.request.query.get('publication_' ~ publication.publication_id) == 'de' %}selected{% endif %}>German</option>
                                            <option value="it" {% if app.request.query.get('publication_' ~ publication.publication_id) == 'it' %}selected{% endif %}>Italian</option>
                                        </select>
                                    </form>
                                </div>

                                <!-- Display translated title and description -->
                                <h4 style="color: #533C56; margin-bottom: 15px; font-weight: 600;">{{ publication.title }}</h4>
                                <p style="color: #555; line-height: 1.7; margin-bottom: 20px;">{{ publication.description }}</p>

                                {% set base64 = publication.getBase64Image() %}
                                {% if base64 %}
                                    <img src="data:image/jpeg;base64,{{ base64 }}" alt="Image" style="max-width: 100%; border-radius: 8px; margin-top: 15px; box-shadow: 0 3px 10px rgba(0,0,0,0.08);">
                                {% endif %}
                            </div>

                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px 25px; background: #f9f6fa; border-bottom-left-radius: 10px; border-bottom-right-radius: 10px;">
                                <button class="btn btn-sm toggle-comments" style="background-color: #99707E; color: white; padding: 6px 15px; border-radius: 20px; text-decoration: none; font-size: 0.9rem; transition: all 0.3s;">
                                    üí¨ Comment
                                </button>

                                <span style="font-size: 0.9rem; color: #533C56;">
                                    {{ publication.comments|length }}
                                    comment{{ publication.comments|length != 1 ? 's' : '' }}
                                </span>
                            </div>

                            <!-- Comments section -->
                            <div class="comments-section" style="display: none; margin-top: 0; padding: 0 25px 20px;">
                                <div style="background: white; border-radius: 8px; box-shadow: inset 0 0 0 1px rgba(83,60,86,0.1); padding: 15px;">
                                    {% for comment in publication.comments %}
                                        <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0e5f2; display: flex; gap: 12px; position: relative;">
                                            <div style="flex-shrink: 0;">
                                                {% if comment.user and comment.user.imgPath %}
                                                    <img src="{{ asset(comment.user.imgPath) }}" alt="User image" style="width: 36px; height: 36px; object-fit: cover; border-radius: 50%; border: 1px solid #e0d0e3;">
                                                {% else %}
                                                    <div style="width: 36px; height: 36px; background-color: #e0d0e3; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #533C56; font-weight: bold;">
                                                        {{ comment.user ? comment.user.username|first|upper : 'A' }}
                                                    </div>
                                                {% endif %}
                                            </div>

                                            <div style="flex-grow: 1;">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <div>
                                                        {% if comment.user %}
                                                            {{ comment.user.username }}
                                                        {% else %}
                                                            Anonymous
                                                        {% endif %}
                                                        <small style="color: #99707E; font-size: 0.8rem; margin-left: 10px;">{{ comment.comment_date|date('M j, Y \\a\\t g:i a') }}</small>
                                                    </div>

                                                    <!-- Display the three vertical dots for comments only if the user is logged in -->
                                                    {% if app.session.get('user_id') %}
                                                        <div class="dropdown text-right" style="position: relative;">
                                                            <button class="btn btn-link dropdown-toggle" type="button" data-toggle="dropdown" aria-label="Comment options" style="font-size: 16px; color: #533C56; padding: 0; margin: 0; background: none; border: none;">
                                                                ‚ãÆ
                                                            </button>
                                                            <ul class="dropdown-menu dropdown-menu-right" style="min-width: 120px; border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-radius: 5px; padding: 5px 0;">
                                                                <!-- Display "Edit" and "Delete" buttons only for the comment author -->
                                                                {% if comment.user and comment.user.id_user == app.session.get('user_id') %}
                                                                    <li style="padding: 0;">
                                                                        <a href="{{ path('app_comment_edit', {'id': comment.comment_id}) }}" style="display: block; padding: 8px 15px; color: #533C56; text-decoration: none;">
                                                                            ‚úèÔ∏è Edit
                                                                        </a>
                                                                    </li>
                                                                    <li style="padding: 0;">
                                                                        <form action="{{ path('app_comment_delete', {'id': comment.comment_id}) }}" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this comment?')">
                                                                            <input type="hidden" name="_token" value="{{ csrf_token('delete_comment' ~ comment.comment_id) }}">
                                                                            <button type="submit" style="background: none; border: none; padding: 8px 15px; color: #e74c3c; text-decoration: none; cursor: pointer; width: 100%; text-align: left;">
                                                                                üóëÔ∏è Delete
                                                                            </button>
                                                                        </form>
                                                                    </li>
                                                                {% endif %}
                                                            </ul>
                                                        </div>
                                                    {% endif %}
                                                </div>

                                                <p style="color: #555; margin: 0; font-size: 0.9rem; line-height: 1.5;">{{ comment.content }}</p>
                                            </div>
                                        </div>
                                    {% else %}
                                        <div style="text-align: center; padding: 15px; color: #99707E;">
                                            <p style="margin: 0;">
                                                <i class="far fa-comment-dots"></i>
                                                No comments yet
                                            </p>
                                        </div>
                                    {% endfor %}
                                </div>
                                <div style="text-align: right; margin-top: 10px;">
                                    <a href="{{ path('app_comment_new', {'id': publication.publication_id}) }}" class="btn btn-sm" style="background-color: #533C56; color: white; padding: 8px 18px; border-radius: 20px; text-decoration: none; font-size: 0.9rem;">
                                        üí¨ Add a comment
                                    </a>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div style="text-align: center; padding: 40px; background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);">
                            <p style="color: #99707E; font-size: 1.1em; margin-bottom: 20px;">No posts yet. Be the first to share your experience!</p>
                            <a href="{{ path('app_publication_new') }}" class="btn btn-primary my-custom-btn" style="background-color: #533C56; border: none; padding: 10px 25px; border-radius: 30px; font-size: 0.9rem; transition: all 0.3s ease;">
                                Create the first post
                            </a>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </section>

    <style>
        .panel:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(83, 60, 86, 0.15);
        }

        .my-custom-btn:hover {
            background-color: #99707E !important;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(83, 60, 86, 0.2);
        }

        .dropdown-menu li a:hover, .dropdown-menu li button:hover {
            background-color: #f5f0f7;
        }

        .toggle-comments:hover {
            background-color: rgba(153, 112, 126, 0.1) !important;
        }

        /* Add extra space between posts */
        .panel + .panel {
            margin-top: 30px;
        }

        /* Style for debugging */
        .debug-user {
            text-align: center;
            margin-bottom: 20px;
            color: #533C56;
        }

        /* Style for flash messages */
        .alert-debug {
            background-color: #e0d0e3;
        }
        .alert-info {
            background-color: #d4edda;
        }
        .alert-error {
            background-color: #f8d7da;
        }
        .alert-success {
            background-color: #d4edda; /* Vert clair pour les messages de succ√®s */
        }
    </style>

    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const toggleButtons = document.querySelectorAll('.toggle-comments');
            toggleButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const commentSection = this.closest('.panel').querySelector('.comments-section');
                    if (commentSection.style.display === 'none' || commentSection.style.display === '') {
                        commentSection.style.display = 'block';
                        this.textContent = 'üí¨ Hide comments';
                    } else {
                        commentSection.style.display = 'none';
                        this.textContent = 'üí¨ Comment';
                    }
                });
            });
        });

        document.addEventListener('DOMContentLoaded', function () { 
            window.onload = function () {
                window.scrollTo({top: 500, behavior: 'smooth'});
            };
        });
    </script>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    {% if app.request.get('post_success') %}
    <script>
        Swal.fire({
            icon: 'success',
            title: 'üéâ Post created successfully!',
            text: 'Your post has been published on the forum.',
            showCancelButton: true,
            confirmButtonText: 'Create another post',
            cancelButtonText: 'Back to forum',
            confirmButtonColor: '#533C56',
            cancelButtonColor: '#aaa',
            footer: '<i class="fa fa-thumbs-up"></i> Thanks for your contribution!',
            background: '#fdf7fd',
            color: '#533C56'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = "{{ path('app_publication_new') }}";
            }
        });
    </script>
    {% endif %}

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const flashMessages = document.querySelectorAll('.alert');
            flashMessages.forEach(function (message) {
                const timeout = message.getAttribute('data-timeout') || 5000; // 5 secondes par d√©faut
                setTimeout(function () {
                    message.style.transition = 'opacity 0.5s ease';
                    message.style.opacity = '0';
                    setTimeout(function () {
                        message.remove();
                    }, 500); // Attendre la fin de la transition avant de supprimer
                }, timeout);
            });
        });
    </script>
{% endblock %}